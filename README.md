# cHFS (cycle-by-cycle adaptation of the Hierarchical Factor Segmentation)
cHFS method is a statistical method for detection of the phase of a biological rhythm shown in an actogram ([Sakura and Yasugi, 2019](https://doi.org/10.1080/07420528.2019.1619572)).

## Overview
cHFS method is based on the HFS method ([Fushing et al., 2009](https://doi.org/10.1007/s00180-008-0134-8); [Fushing et al., 2010](https://doi.org/10.1198/jcgs.2009.07141)).

### HFS process
1. The candidate onsets are generated by using three thresholds.
1. In the candidates, the optimal onsets, which produce least value of the score calculated from the mean squre error (MSE), penalty, and penalty weight are detected.
	- Penalty is the sum of the following two values:
		1. the number of rows without detected onsets
		1. the difference between the total number of detected onsets and the number of rows with at least one detected onset
	- The score is defined as `(MSE) + (penalty wight) * (penalty)`.

### cHFS process
The cHFS consists two processes.

#### first process
1. An actogram is divided into some parts.
1. Each part is analyzed by the HFS method independently.
1. All detected onsets are concatenated.

#### second process
1. The candidate onsets produced by the first process are enumerated according to the number of parts.
1. In the candidates, the optimal onsets, which produce the least value of the summation of the MSE and penalty are detected.

## Build
```console
$ git clone https://github.com/KazukiSakura/cHFS.git
$ cd cHFS
$ make
```

### Requirements
- C++ compiler supporting C++17
- Make

## Usage
```console
$ ./chfs -h
$ ./chfs -f sample.csv -o output.csv -c 24.0 -r 0.1
```

### Input file (-f)
- Option format: file name
	- Read from stdin when `-` is specified
- File format: CSV
	- New lines are ignored
	- Each value must be an integer value which represents an existence of activity per unit time
		- zero: a non-existence of activity
		- non-zero: an existence of activity

### Output file (-o)
- Option format: file name
	- Write to stdout when `-` is specified or this option is omitted
- File format: CSV or JSON
	- If `-v` option is not given, output the detected onset times in a form of single line CSV
	- Otherwise, output results with detailed intermediate values for debug in a form of JSON

### Expected cycle (-c)
- Option format: real value
	- cycle period in which single onset should be included
	- E.g. `24.0` is specfied if input actogram is expected by the biological knowledge to show circadian rhythm
- Default value: `24.0`

### Measurement resolution (-r)
- Option format: real value
	- unit time in input file
	- E.g. `0.1` is specfied if input shows activities per 6 minutes (0.1 hours)
- Default value: `0.1`

### Penalty weight (-w)
- Option format: real value
	- ratio of penalty in the score of regression analysis
		- When it is too large, the number of the detected onsets should be close to the number of cycles in the input actogram, but the onsets might be scattered
		- When it is too small, the detected onsets should be alined, but the number of the onsets might be smaller than the number of cycles
- Default value: `1.0`

### Verbose mode (-v)
- Option format: integer value between 1 and 5

### HFS method mode (-a)
- Option format: none
	- Switch to the HFS method, not cHFS

### Help (-h)
- Option format: none
	- Show brief description of usage
